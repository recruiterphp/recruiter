#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use Recruiter\Recruiter;
use Recruiter\Worker;

$pid = posix_getpid();
$askedToStop = false;
foreach (array(SIGTERM, SIGQUIT, SIGINT) as $signo) {
    pcntl_signal($signo, function($signo) use (&$askedToStop, $pid) {
        $askedToStop = true;
        printf(
            '[WORKER][%d][%s] politely asked to stop' . PHP_EOL,
            $pid, date('c')
        );
    });
}

$options = array_merge(['host' => 'localhost:27017'], getopt('', ['host:']));

$db = (new MongoClient($options['host']))->selectDB('recruiter');
$recruiter = new Recruiter($db);
$worker = $recruiter->hire();

printf('[WORKER][%d][%s] ready to work!' . PHP_EOL, $pid, date('c'));

while (!$askedToStop) {
    $doneSomeWork = $worker->work();
    if (!$doneSomeWork) usleep(1000 * 200);
    pcntl_signal_dispatch();
}

printf('[WORKER][%d][%s] ok, see you space cowboy...' . PHP_EOL, $pid, date('c'));
