#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use Recruiter\Recruiter;
use Recruiter\Worker;

GracefulDeath::around(function($life) {

    $pid = posix_getpid();
    $options = array_merge(['host' => 'localhost:27017'], getopt('', ['host:']));

    $db = (new MongoClient($options['host']))->selectDB('recruiter');
    $recruiter = new Recruiter($db);
    $worker = $recruiter->hire();

    printf('[WORKER][%d][%s] ready to work!' . PHP_EOL, $pid, date('c'));

    while (!$life->askedToStop()) {
        $doneSomeWork = $worker->work();
        if (!$doneSomeWork) usleep(1000 * 200);
    }

    printf('[WORKER][%d][%s] ok, see you space cowboy...' . PHP_EOL, $pid, date('c'));

})
->doNotCaptureOutput()
->catchSignals([SIGTERM, SIGQUIT, SIGINT])
->reanimationPolicy(function() {
    printf('[WORKER-SUPERVISOR][%d][%s] respawn!'. PHP_EOL, posix_getpid(), date('c'));
    return true;
})
->run();
