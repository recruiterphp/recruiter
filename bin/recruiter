#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use Recruiter\Recruiter;
use Rych\ByteSize\ByteSize;

GracefulDeath::around(function($life) {

    $pid = posix_getpid();
    $options = array_merge([
            'host' => 'localhost:27017',
            'memory-limit' => 33554432, // 32MB
        ],
        getopt('', ['host:', 'memory-limit:'])
    );

    $db = (new MongoClient($options['host']))->selectDB('recruiter');
    $recruiter = new Recruiter($db);

    while (!$life->askedToStop()) {
        $currentMemoryUsage = memory_get_usage();
        $pickStartAt = microtime(true);
        $numberOfAssignments = $recruiter->assignJobsToWorkers();
        $pickEndAt = microtime(true);
        printf(
            '[RECRUITER][%d][%s][%s] picked jobs for %d workers in %fms' . PHP_EOL,
            $pid, date('c'), ByteSize::formatMetric($currentMemoryUsage),
            $numberOfAssignments, ($pickEndAt - $pickStartAt) * 1000
        );
        if ($currentMemoryUsage > (int)$options['memory-limit']) exit(1);
        if ($numberOfAssignments === 0) usleep(1000 * 200);
    }

    printf('[RECRUITER][%d][%s] ok, see you space cowboy...' . PHP_EOL, $pid, date('c'));

})
->doNotCaptureOutput()
->catchSignals([SIGTERM, SIGQUIT, SIGINT])
->reanimationPolicy(function() {
    printf('[RECRUITER-SUPERVISOR][%d][%s] respawn!'. PHP_EOL, posix_getpid(), date('c'));
    return true;
})
->run();
